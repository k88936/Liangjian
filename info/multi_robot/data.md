## 机器人仓库调度系列赛（一）：多智能体路径规划

### 系列赛说明

基于“货到人”的智能仓库系统是近几年出现的一种新型配送中心仓储管理模式。由仓储机器人代替人工来完成仓库系统内部繁杂的拣货工作，在一定程度上有效提高了拣货效率。

该系列赛通过对此仓储管理模式下各个场景进行抽象，形成了路径规划、密集存储、任务分配等一系列从简到繁的赛题。

### 赛题说明

参赛者根据地图内的所有信息进行路径规划，不仅要考虑单个机器人的最优路径，还要考虑多个机器人同时运动时的干扰，最终使所有机器人到达目标点的总时间最短。

#### 概念说明

为防止概念混淆，先给出几个定义，全文出现的概念以此定义为准：

- 模拟器：用于模拟整个场景，实现机器人行为，货架渲染以及地图渲染。
- 时间片断：模拟器时间不依赖系统时间而是通过迭代模拟，每次迭代更新模拟器之后，时间进行累计。每一次迭代为一个时间片断。
- 地图：仓库场景信息描述。通过矩阵的方式对仓库的位置信息，通行方向等进行描述。
- 单元格：矩阵地图中的一个元素，包含位置信息，可通行方向，类型等信息。
- 障碍：单元格类型为 BLOCK_CELL，此类型的单元格机器人不能行驶。
- 机器人：智能体，可以在地图上行驶并执行一系列的动作。
- 预留队列：预分配给机器人的单元格，机器人将沿着分配的单元格前进，经过的单元格会被释放。已经被分配的单元格无法再分配给其他机器人。

#### 赛题场景信息

共有 4 张地图，地图尺寸大小不一，障碍分布不同。每张地图上有 N 个机器人，每个机器人有对应的初始位置和方向以及相对应的任务。
四种场景，分别为：1.基础场景,少量机器人(下图左上)2.基础障碍场景,多机器人(下图右上)3.单通道场景,多机器人(下图左下)4.大地图随机障碍场景，多机器人(下图右下)
图例说明：浅蓝色方块为地图基本点;灰色方块为障碍点;彩色圆形为机器人，上面的数字代码机器人 ID;跟机器人颜色相同的彩色方块为机器人对应的终点。

![](/uploads/editor/all_20201202153457274390.jpg)

### 模拟器说明

#### 机器人行为描述

机器人仓库调度系列赛都是基于控制机器人的行为，以达到最终的目标。在多智能体路径规划赛题中，我们主要控制机器人的移动和原地转向两个行为。

1. 机器人移动：通过给机器人设置路径的方式，使其移动。路径为连续单元格的集合。机器人移动速度受预留队列长度及转弯影响：
   - 机器人最大速度为 1，计算公式为：预留队列中转弯点之前的列表长度-1/预留队列最大长度-1；
   - 机器人移动至下一个单元格的判定是通过 position 值来判断的。当 position 大于等于 1 时，表示机器人移动至下一个单元格，此时 position 值会重置为 0。position 值是通过当前机器人的速度进行累加计算得出的。
   - 当机器人在移动过程中发生转弯时，转弯动作的完成时间需要 2 个时间片断。转弯动作完成后才会继续移动。
2. 原地转向：机器人到达目标点后，如果方向跟目标方向不一致。可通地原地转向的行为进行调整。原地转向行为需要进行 2 个时间片断。
   - 方向值的计算方式为：设当前位置单元格坐标为(x1,y1)，下一步移动目标单元格坐标为(x2,y2)。若 x1=x2,y2-y1=-1，则方向为 1；若 x1=x2,y2-y1=1，则方向为 3；若 y1=y2,x2-x1=-1，则方向为 2；若 y1=y2,x2-x1=-1，则方向为 4。

#### 模拟器约束描述

- 预留队列的最大长度为 4，超过预留队列最大长度的申请将被丢弃。
- 新申请的路径第一个单元格必须为预留队列的最后一个单元格。如果预留队列为空，则新申请的路径第一个单元格为机器人当前所在单元格。
- 机器人只可以向相邻的单元格行驶，不能斜向行驶，障碍不能行驶。
- 原地转向只能在机器人停止的状态（预留队列长度为 0 或者预留队列内只有机器人当前所在单元格）才可以执行，其他情况下原地转向命令将被忽略

#### 运行环境依赖

| 软件环境 | 版本  |
| -------- | ----- |
| java     | jre8  |
| python   | 3.7.4 |

| python 包  | 版本   |
| ---------- | ------ |
| grpcio     | 1.28.1 |
| protobuf   | 3.11.3 |
| websockets | 8.1    |

#### 算法 DEMO 描述

##### 算法启动流程

```
* 注：算法Demo只保证接口连通性，仅作为参考。
# 1. 选择对应的Demo包下载，目前只支持Java以及Python两种语言

# 2. 启动算法服务
	Java：项目入口文件为 src/main/java/com/geekplus/hypercompass/demo/RobotAlgorithmDemo.java
	Python: 项目入口文件为 algoService.py

# 3. 算法服务端口号为：10022
```

#### 算法开发调试流程

```
1. 新建项目目录[example]
2. 下载算法验证程序模拟器,并解压到项目目录中
3. 下载对应开发语言的Demo包，并解压到项目目录中
4. 项目目录如下：
   - example
      - [验证模拟器] (目录)
      - demo (目录)
5. 启动算法Demo, 用编辑器加载Demo，然后启动算法服务
6. 启动算法验证程序界面，在[验证模拟器]目录下，执行 python multi_robot.py
7. 点击界面中的开始按钮
```

#### 接口说明

##### 算法接收的接口（hephaestus_pb2.RobotEnvironmentContext）

| 字段名    | 字段说明                           |
| --------- | ---------------------------------- |
| timestamp | 当前模拟器运行的时间片断值         |
| width     | 地图的宽度                         |
| height    | 地图的高度                         |
| robots    | 地图中所有机器人(<Robot>)的集合    |
| mapCells  | 地图中所有单元格(<MapCell>)的集合  |
| tasks     | 所有的任务(<Task>)信息             |
| isInit    | 是否为初次执行，主要用于算法初始化 |

##### 算法返回接口（hephaestus_pb2.RobotAlgorithmResult）

| 字段名                | 子字段    | 字段说明                     |
| --------------------- | --------- | ---------------------------- |
| robotAlgorithmUpdates |           | RobotAlgorithmUpdates 的集合 |
| RobotAlgorithmUpdates |           | 为一个机器人设置路径         |
|                       | robotId   | 机器人 ID                    |
|                       | cells     | 机器人路径单元格的集合       |
|                       | direction | 机器人转向                   |

##### 基础字段说明

| 字段名  | 子字段        | 字段说明                                                                                               |
| ------- | ------------- | ------------------------------------------------------------------------------------------------------ |
| Robot   | robotId       | 机器人 id, 唯一                                                                                        |
| -       | locationIndex | 机器人当前位置                                                                                         |
| -       | nextIndex     | 机器人前进的位置，当 locationIndex 和 nextIndex 相同时表示机器人在点上，不同时表示机器人在两个格子中间 |
| -       | assignedPath  | 预留队列列表                                                                                           |
| -       | position      | 机器人在两个格子中间的状态取值在 0-1 之间                                                              |
| MapCell | cellCode      | 地图节点 code, 唯一                                                                                    |
| -       | index         | 地图节点在整个地图中的索引位置，索引起始点(0,0)为地图的左下角                                          |
| -       | location      | 地图节点在实际仓库中的位置信息                                                                         |
| -       | directionCost | 负载状态下该单元格可以行驶的方向                                                                       |
| Task    | robotId       | 机器人 ID                                                                                              |
| -       | Index         | 机器人起始点坐标                                                                                       |
| -       | dest          | 机器人目标点坐标                                                                                       |
|         | direction     | 机器人初始方向                                                                                         |
|         | endDirection  | 机器人最终方向                                                                                         |

#### 算法评分方式

1. 单次执行完成所有任务的时间和 T:

   $$
   T = \sum_{i=1}^{4}t_i
   $$

2. 最终成绩为执行 2 次 T 的平均值，**score 值越小越好**：

   $$
   score = \frac{\sum_{i=1}^{10}T_i}{10}
   $$

3. 算法超时或错误成绩为 0

#### 算法提交说明

1. 目前只支持提交 Java 和 Python 两种语言的代码
2. Java 语言最终提交的为 Jar 包
3. Python 语言最终提交的为 pyz 文件包
4. 上传文件大小限制不超过 20Mb

#### FAQ

1. 目前支持的程序语言有哪些？

   目前只支持 python 和 Java 两种语言。

2. pyz 文件如何生成？
   在算法目录的上一级执行命令,就可以生成 pyz 文件

3. 模拟器打开报错是什么原因？

   目前 web 版的模拟器只支持新版 chrome 或其他 chrome 内核浏览器；后台报错请检查相关依赖是否安装完成。
